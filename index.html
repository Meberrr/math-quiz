<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ•¸å­¸å‰å¾Œæ¸¬å•å·</title>
  <style>
    body { font-family: "Microsoft JhengHei"; margin: 40px; background-color: #f9f9f9; text-align: left; }
    h2 { color: #2a4d8f; text-align: left; }
    input, select, textarea { padding: 6px; margin: 6px; font-size: 15px; }
    button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    button:hover:not(:disabled) { background-color: #45a049; }
    .hidden { display: none; }

    ol { list-style-position: inside; padding-left: 20px; }
    ol li { margin-bottom: 14px; text-indent: -1.5em; }
    ol li::marker { content: counter(list-item) ".â€ƒ"; font-weight: bold; }

    .feedback-section {
      margin-top: 25px;
      padding: 10px 15px;
      background-color: #eef3ff;
      border-radius: 10px;
      border: 1px solid #cdd5ef;
    }
    textarea {
      width: 90%;
      height: 80px;
      resize: none;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>

<body>

<h2>æ•¸å­¸å‰å¾Œæ¸¬å•å·</h2>

<!-- âœ… é¸æ“‡éšæ®µ -->
<div id="stageSelectArea">
  <p><strong>è«‹é¸æ“‡ç›®å‰é€²è¡Œçš„æ¸¬é©—éšæ®µï¼š</strong></p>
  <button onclick="selectStage('å‰æ¸¬')">å‰æ¸¬</button>
  <button onclick="selectStage('å¾Œæ¸¬')">å¾Œæ¸¬</button>
</div>

<!-- âœ… å•å·ä¸»é«” -->
<div id="quizArea" class="hidden">
  <p><strong>æ¸¬é©—éšæ®µï¼š</strong><span id="testTypeLabel"></span></p>
  <p><strong>è‡ªè¨‚ä»£è™Ÿï¼ˆå…±å››ç¢¼ï¼‰</strong>ï¼šç”Ÿæ—¥æœˆä»½ + åº§è™Ÿï¼ˆä¾‹å¦‚ï¼š7æœˆ3è™Ÿ â†’ 0703ï¼‰</p>

  <p><strong>è«‹é¸æ“‡æ¸¬é©—çš„é—œå¡ï¼š</strong></p>
  <select id="classSelect">
    <option value="ç¬¬ä¸€é—œ">ç¬¬ä¸€é—œ</option>
    <option value="ç¬¬äºŒé—œ">ç¬¬äºŒé—œ</option>
    <option value="ç¬¬ä¸‰é—œ">ç¬¬ä¸‰é—œ</option>
  </select>

  <input type="text" id="studentId" placeholder="è«‹è¼¸å…¥è‡ªè¨‚ä»£è™Ÿï¼ˆå››ç¢¼ï¼‰" />

  <form id="quizForm">
    <ol>
      <li>11 + 27 = <input type="number" id="Q1"></li>
      <li>2 Ã— 12 Ã— 19 = <input type="number" id="Q2"></li>
      <li>24 Ã— 3 Ã— 11 = <input type="number" id="Q3"></li>
      <li>32 Ã· 4 + 4 = <input type="number" id="Q4"></li>
      <li>15 Ã· 3 Ã— 23 = <input type="number" id="Q5"></li>
      <li>9 Ã— 6 Ã· 27 = <input type="number" id="Q6"></li>
      <li>15 Ã— (30 - 13) = <input type="number" id="Q7"></li>
      <li>21 Ã— (27 Ã· 3) = <input type="number" id="Q8"></li>
      <li>(30 - 14) Ã· 4 = <input type="number" id="Q9"></li>
    </ol>
    <button type="button" id="submitBtn" onclick="submitQuiz()">é€å‡ºç­”æ¡ˆ</button>
  </form>

  <!-- âœ… ç¬¬äºŒéšæ®µï¼ˆå¾Œæ¸¬é€å‡ºå¾Œæ‰å‡ºç¾ï¼‰ -->
  <div id="feedbackArea" class="feedback-section hidden">
    <p><strong>è«‹å•æ‚¨æ˜¯å¦æœ‰é€šé—œï¼Ÿï¼ˆå¿…å¡«ï¼‰</strong></p>
    <label><input type="radio" name="cleared" value="æ˜¯"> æ˜¯</label>
    <label><input type="radio" name="cleared" value="å¦"> å¦</label>

    <p><strong>å…¶ä»–å»ºè­°èˆ‡å›é¥‹ï¼ˆé¸å¡«ï¼‰ï¼š</strong></p>
    <textarea id="feedback" placeholder="è«‹è¼¸å…¥æ‚¨çš„æ„è¦‹æˆ–å»ºè­°..."></textarea><br>

    <button type="button" id="finalSubmitBtn" onclick="submitFeedback()">é€å‡ºå›é¥‹</button>
  </div>

  <p id="result"></p>
</div>

<script>
  // âœ… Firebase è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyD9LY_TmhTJjEbtWkYLX9OsqTCZKYafjPg",
    authDomain: "math-quiz-a0fcf.firebaseapp.com",
    projectId: "math-quiz-a0fcf",
    storageBucket: "math-quiz-a0fcf.firebasestorage.app",
    messagingSenderId: "137657638927",
    appId: "1:137657638927:web:b6c450f8cec9978620c37a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let selectedTestType = "";
  let docId = null;

  function selectStage(type) {
    selectedTestType = type;
    document.getElementById("testTypeLabel").textContent = type;
    document.getElementById("stageSelectArea").classList.add("hidden");
    document.getElementById("quizArea").classList.remove("hidden");
    window.startTime = Date.now();
  }

  async function submitQuiz() {
    const btn = document.getElementById("submitBtn");
    btn.disabled = true;

    const data = {
      testType: selectedTestType,
      class: document.getElementById("classSelect").value,
      studentId: document.getElementById("studentId").value.trim(),
      Q1: document.getElementById("Q1").value,
      Q2: document.getElementById("Q2").value,
      Q3: document.getElementById("Q3").value,
      Q4: document.getElementById("Q4").value,
      Q5: document.getElementById("Q5").value,
      Q6: document.getElementById("Q6").value,
      Q7: document.getElementById("Q7").value,
      Q8: document.getElementById("Q8").value,
      Q9: document.getElementById("Q9").value,
    };

    const result = calculateScore();
    data.correctCount = result.correctCount;
    data.score = result.score;
    data.timeSpent = ((Date.now() - window.startTime) / 1000).toFixed(2);
    data.timestamp = new Date();
    data.cleared = "";
    data.feedback = "";

    try {
      const docRef = await db.collection("quizResults").add(data);
      docId = docRef.id;

      alert(`ä½œç­”å®Œæˆï¼æ„Ÿè¬æ‚¨çš„åƒèˆ‡ï¼ˆ${selectedTestType}ï¼‰ğŸ™Œ`);

      if (selectedTestType === "å¾Œæ¸¬") {
        document.getElementById("feedbackArea").classList.remove("hidden");
      }

      document.getElementById("result").innerHTML =
        `<strong>âœ… ${selectedTestType}è³‡æ–™å·²é€å‡ºï¼</strong>`;

      document.querySelectorAll("input[type='number']").forEach(el => el.disabled = true);

    } catch (err) {
      alert("âŒ éŒ¯èª¤ï¼š" + err.message);
      btn.disabled = false;
    }
  }

  async function submitFeedback() {
    const cleared = document.querySelector('input[name="cleared"]:checked');
    const feedback = document.getElementById("feedback").value.trim();

    if (!cleared) {
      alert("è«‹å…ˆå‹¾é¸æ˜¯å¦é€šé—œï¼");
      return;
    }

    try {
      await db.collection("quizResults").doc(docId).update({
        cleared: cleared.value,
        feedback: feedback
      });

      // âœ… å®Œå…¨é‡å¯« bodyï¼Œç”Ÿæˆæ„Ÿè¬ç•«é¢ï¼ˆä¸æœƒé–ƒç¾ï¼‰
      document.body.innerHTML = `
        <div style="
          display:flex;
          justify-content:center;
          align-items:center;
          height:80vh;
          font-size:28px;
          font-weight:bold;
          color:#2a4d8f;
          text-align:center;">
          æ„Ÿè¬é…åˆæ–½æ¸¬ï¼è«‹ç¨ç­‰å…¶ä»–åŒå­¸ï½
        </div>
      `;

    } catch (err) {
      alert("âŒ å›é¥‹ä¸Šå‚³å¤±æ•—ï¼š" + err.message);
    }
  }

  function calculateScore() {
    const correct = [38, 456, 792, 12, 115, 2, 255, 189, 4];
    let correctCount = 0;
    for (let i = 1; i <= 9; i++) {
      if (parseInt(document.getElementById(`Q${i}`).value) === correct[i - 1]) {
        correctCount++;
      }
    }
    const score = Math.round((correctCount / 9) * 100);
    return { correctCount, score };
  }
</script>

</body>
</html>
